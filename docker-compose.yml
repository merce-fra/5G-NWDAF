services:
  zookeeper:
    container_name: ${ZOOKEEPER_SERVICE_NAME}
    image: confluentinc/cp-zookeeper:7.7.1
    ports:
      - ${ZOOKEEPER_SERVICE_PORT}:${ZOOKEEPER_SERVICE_PORT}
    environment:
      ZOOKEEPER_CLIENT_PORT: ${ZOOKEEPER_SERVICE_PORT}
      ZOOKEEPER_TICK_TIME: 2000
      ZOOKEEPER_LOG4J_ROOT_LOGLEVEL: ${ZOOKEEPER_LOG_LEVEL}
    networks:
      - nwdaf-network

  kafka:
    container_name: ${KAFKA_SERVICE_NAME}
    image: confluentinc/cp-kafka:7.7.1
    ports:
      - ${KAFKA_SERVICE_PORT}:${KAFKA_SERVICE_PORT}
    depends_on:
      - ${ZOOKEEPER_SERVICE_NAME}
    environment:
      KAFKA_ADVERTISED_LISTENERS: PLAINTEXT://${KAFKA_SERVICE_NAME}:${KAFKA_SERVICE_PORT}
      KAFKA_LISTENER_SECURITY_PROTOCOL_MAP: PLAINTEXT:PLAINTEXT
      KAFKA_INTER_BROKER_LISTENER_NAME: PLAINTEXT
      KAFKA_ZOOKEEPER_CONNECT: ${ZOOKEEPER_SERVICE_NAME}:${ZOOKEEPER_SERVICE_PORT}
      KAFKA_BROKER_ID: 1
      KAFKA_LOG4J_ROOT_LOGLEVEL: ${KAFKA_LOG_LEVEL}
      KAFKA_LOG4J_LOGGERS: kafka=${KAFKA_LOG_LEVEL},kafka.controller=${KAFKA_LOG_LEVEL},kafka.log.LogCleaner=${KAFKA_LOG_LEVEL},state.change.logger=${KAFKA_LOG_LEVEL},kafka.producer.async.DefaultEventHandler=${KAFKA_LOG_LEVEL}
      KAFKA_OFFSETS_TOPIC_REPLICATION_FACTOR: 1
      KAFKA_AUTO_CREATE_TOPICS_ENABLE: true
    networks:
      - nwdaf-network

  kafka-topics-init:
    container_name: ${TOPICS_INIT_SERVICE_NAME}
    build:
      context: .
      network: host
      args:
        - BASE_IMAGE=${DOCKER_BASE_IMAGE}
        - GITLAB_TOKEN_NAME=${GITLAB_TOKEN_NAME}
        - GITLAB_TOKEN_VALUE=${GITLAB_TOKEN_VALUE}
        - SERVICE_DIR=services/kafka-topics-init
        - SCRIPT_NAME=kafka-topics-init.py
    environment:
      - TOPICS_INIT_SERVICE_NAME=${TOPICS_INIT_SERVICE_NAME}
      - TOPICS_INIT_LOG_LEVEL=${TOPICS_INIT_LOG_LEVEL}
      - KAFKA_BOOTSTRAP_SERVER=${KAFKA_SERVICE_NAME}:${KAFKA_SERVICE_PORT}
    depends_on:
      - ${KAFKA_SERVICE_NAME}
    networks:
      - nwdaf-network

  notification-client:
    container_name: ${NOTIF_CLIENT_SERVICE_NAME}
    build:
      context: .
      network: host
      args:
        - BASE_IMAGE=${DOCKER_BASE_IMAGE}
        - GITLAB_TOKEN_NAME=${GITLAB_TOKEN_NAME}
        - GITLAB_TOKEN_VALUE=${GITLAB_TOKEN_VALUE}
        - SERVICE_DIR=nf-stubs/notification-client
        - SCRIPT_NAME=notification-client.py
    environment:
      - NOTIF_CLIENT_SERVICE_NAME=${NOTIF_CLIENT_SERVICE_NAME}
      - NOTIF_CLIENT_SERVICE_PORT=${NOTIF_CLIENT_SERVICE_PORT}
      - NOTIF_CLIENT_LOG_LEVEL=${NOTIF_CLIENT_LOG_LEVEL}
    ports:
      - ${NOTIF_CLIENT_SERVICE_PORT}:${NOTIF_CLIENT_SERVICE_PORT}
    restart: on-failure
    networks:
      - nwdaf-network

  api-gateway:
    container_name: ${API_GW_SERVICE_NAME}
    build:
      context: .
      network: host
      args:
        - BASE_IMAGE=${DOCKER_BASE_IMAGE}
        - GITLAB_TOKEN_NAME=${GITLAB_TOKEN_NAME}
        - GITLAB_TOKEN_VALUE=${GITLAB_TOKEN_VALUE}
        - SERVICE_DIR=services/api-gateway
        - SCRIPT_NAME=main.py
    environment:
      - API_GW_SERVICE_NAME=${API_GW_SERVICE_NAME}
      - API_GW_SERVICE_PORT=${API_GW_SERVICE_PORT}
      - API_GW_LOG_LEVEL=${API_GW_LOG_LEVEL}
      - KAFKA_BOOTSTRAP_SERVER=${KAFKA_SERVICE_NAME}:${KAFKA_SERVICE_PORT}
      - GMLC_SERVICE_NAME=${GMLC_SERVICE_NAME}
      - GMLC_SERVICE_PORT=${GMLC_SERVICE_PORT}
      - RAN_SERVICE_NAME=${RAN_SERVICE_NAME}
      - RAN_SERVICE_PORT=${RAN_SERVICE_PORT}
    depends_on:
      kafka-topics-init:
        condition: service_completed_successfully
    ports:
      - ${API_GW_SERVICE_PORT}:${API_GW_SERVICE_PORT}
    restart: on-failure
    networks:
      - nwdaf-network

  thr-anlf:
    container_name: ${THR_ANLF_SERVICE_NAME}
    build:
      context: .
      network: host
      args:
        - BASE_IMAGE=${DOCKER_BASE_IMAGE}
        - GITLAB_TOKEN_NAME=${GITLAB_TOKEN_NAME}
        - GITLAB_TOKEN_VALUE=${GITLAB_TOKEN_VALUE}
        - SERVICE_DIR=services/thr-anlf
        - SCRIPT_NAME=main.py
    environment:
      - THR_ANLF_SERVICE_NAME=${THR_ANLF_SERVICE_NAME}
      - THR_ANLF_LOG_LEVEL=${THR_ANLF_LOG_LEVEL}
      - KAFKA_BOOTSTRAP_SERVER=${KAFKA_SERVICE_NAME}:${KAFKA_SERVICE_PORT}
    depends_on:
      kafka-topics-init:
        condition: service_completed_successfully
    restart: on-failure
    networks:
      - nwdaf-network

  thr-mtlf:
    container_name: ${THR_MTLF_SERVICE_NAME}
    build:
      context: .
      network: host
      args:
        - BASE_IMAGE=${DOCKER_BASE_IMAGE}
        - GITLAB_TOKEN_NAME=${GITLAB_TOKEN_NAME}
        - GITLAB_TOKEN_VALUE=${GITLAB_TOKEN_VALUE}
        - SERVICE_DIR=services/thr-mtlf
        - SCRIPT_NAME=main.py
    environment:
      - THR_MTLF_SERVICE_NAME=${THR_MTLF_SERVICE_NAME}
      - THR_MTLF_LOG_LEVEL=${THR_MTLF_LOG_LEVEL}
      - KAFKA_BOOTSTRAP_SERVER=${KAFKA_SERVICE_NAME}:${KAFKA_SERVICE_PORT}
    depends_on:
      kafka-topics-init:
        condition: service_completed_successfully
    restart: on-failure
    networks:
      - nwdaf-network

  gmlc:
    container_name: ${GMLC_SERVICE_NAME}
    build:
      context: .
      network: host
      args:
        - BASE_IMAGE=${DOCKER_BASE_IMAGE}
        - GITLAB_TOKEN_NAME=${GITLAB_TOKEN_NAME}
        - GITLAB_TOKEN_VALUE=${GITLAB_TOKEN_VALUE}
        - SERVICE_DIR=nf-stubs/gmlc
        - SCRIPT_NAME=gmlc.py
    environment:
      - GMLC_SERVICE_NAME=${GMLC_SERVICE_NAME}
      - GMLC_SERVICE_PORT=${GMLC_SERVICE_PORT}
      - GMLC_LOG_LEVEL=${GMLC_LOG_LEVEL}
    ports:
      - ${GMLC_SERVICE_PORT}:${GMLC_SERVICE_PORT}
    restart: on-failure
    networks:
      - nwdaf-network

  ran:
    container_name: ${RAN_SERVICE_NAME}
    build:
      context: .
      network: host
      args:
        - BASE_IMAGE=${DOCKER_BASE_IMAGE}
        - GITLAB_TOKEN_NAME=${GITLAB_TOKEN_NAME}
        - GITLAB_TOKEN_VALUE=${GITLAB_TOKEN_VALUE}
        - SERVICE_DIR=nf-stubs/ran
        - SCRIPT_NAME=ran.py
    environment:
      - RAN_SERVICE_NAME=${RAN_SERVICE_NAME}
      - RAN_SERVICE_PORT=${RAN_SERVICE_PORT}
      - RAN_LOG_LEVEL=${RAN_LOG_LEVEL}
    ports:
      - ${RAN_SERVICE_PORT}:${RAN_SERVICE_PORT}
    restart: on-failure
    networks:
      - nwdaf-network

  csv-file-player:
    container_name: ${CSV_FP_SERVICE_NAME}
    build:
      context: .
      network: host
      args:
        - BASE_IMAGE=${DOCKER_BASE_IMAGE}
        - GITLAB_TOKEN_NAME=${GITLAB_TOKEN_NAME}
        - GITLAB_TOKEN_VALUE=${GITLAB_TOKEN_VALUE}
        - SERVICE_DIR=nf-stubs/csv_file_player
        - SCRIPT_NAME=main.py
    environment:
      - CSV_FP_SERVICE_NAME=${CSV_FP_SERVICE_NAME}
      - CSV_FP_SERVICE_PORT=${CSV_FP_SERVICE_PORT}
      - CSV_FP_LOG_LEVEL=${CSV_FP_LOG_LEVEL}
      - GMLC_SERVICE_NAME=${GMLC_SERVICE_NAME}
      - GMLC_SERVICE_PORT=${GMLC_SERVICE_PORT}
      - RAN_SERVICE_NAME=${RAN_SERVICE_NAME}
      - RAN_SERVICE_PORT=${RAN_SERVICE_PORT}
    ports:
      - ${CSV_FP_SERVICE_PORT}:${CSV_FP_SERVICE_PORT}
    restart: on-failure
    networks:
      - nwdaf-network


  prometheus:
    image: bitnami/prometheus:2.55.1
    container_name: ${PROMETHEUS_SERVICE_NAME}
    ports:
      - ${PROMETHEUS_SERVICE_PORT}:${PROMETHEUS_SERVICE_PORT}
    volumes:
      - ./prometheus/prometheus.yml:/etc/prometheus/prometheus.yml
    command:
      - --config.file=/etc/prometheus/prometheus.yml
      - --log.level=${PROMETHEUS_LOG_LEVEL}
    networks:
      - nwdaf-network

  grafana:
    image: grafana/grafana:10.4.12
    container_name: ${GRAFANA_SERVICE_NAME}
    ports:
      - ${GRAFANA_SERVICE_PORT}:${GRAFANA_SERVICE_PORT}
    environment:
      - GF_SECURITY_ADMIN_PASSWORD=${GRAFANA_ADMIN_PASSWORD}
      - GF_LOG_LEVEL=${GRAFANA_LOG_LEVEL}
    volumes:
      - grafana-storage:/var/lib/grafana
    networks:
      - nwdaf-network

networks:
  nwdaf-network:
    driver: bridge

volumes:
  grafana-storage: